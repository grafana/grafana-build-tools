FROM registry.hub.docker.com/library/golang:{{ .data.go }} as go

    COPY lib/go.env /usr/local/go

FROM go as tools
    RUN env GOBIN=/build go install github.com/google/go-jsonnet/cmd/jsonnet@{{ .data.go_jsonnet }}
    RUN env GOBIN=/build go install github.com/google/go-jsonnet/cmd/jsonnetfmt@{{ .data.go_jsonnet }}
    RUN env GOBIN=/build go install github.com/google/go-jsonnet/cmd/jsonnet-deps@{{ .data.go_jsonnet }}
    RUN env GOBIN=/build go install github.com/google/go-jsonnet/cmd/jsonnet-lint@{{ .data.go_jsonnet }}

    # Add wire
    RUN env GOBIN=/build go install github.com/google/wire/cmd/wire@{{ .data.wire }}

    # Add bingo
    RUN env GOBIN=/build go install github.com/bwplotka/bingo@{{ .data.bingo }}

    # Add dockerfile-json
    RUN git clone --depth 1 --branch {{ .data.dockerfile_json }} https://github.com/keilerkonzept/dockerfile-json dockerfile-json && \
        cd dockerfile-json && \
        env GOBIN=/build go install .

    # Add enumer
    RUN env GOBIN=/build go install github.com/dmarkham/enumer@{{ .data.enumer }}

    # Add protoc-gen-go
    RUN env GOBIN=/build go install google.golang.org/protobuf/cmd/protoc-gen-go@{{ .data.protoc_gen_go }}

    # Add protoc-gen-go-grpc
    RUN env GOBIN=/build go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@{{ .data.protoc_gen_go_grpc }}

    # Add buf
    RUN env GOBIN=/build go install github.com/bufbuild/buf/cmd/buf@{{ .data.buf }}

    # Add mage
    RUN git clone --depth 1 --branch {{ .data.mage }} https://github.com/magefile/mage mage && \
        cd mage && \
        env GOBIN=/build go run bootstrap.go

    # Add nilaway
    RUN env GOBIN=/build go install go.uber.org/nilaway/cmd/nilaway@{{ .data.nilaway }}

    # Add grizzly
    RUN env GOBIN=/build go install github.com/grafana/grizzly/cmd/grr@{{ .data.grizzly }}

    # Add semversort
    RUN env GOBIN=/build go install github.com/whereswaldon/semversort@{{ .data.semversort }}

    # Add golangci-lint
    RUN env GOBIN=/build go install github.com/golangci/golangci-lint/cmd/golangci-lint@{{ .data.golangci_lint }}

    # Add shellcheck
    COPY --from=registry.hub.docker.com/koalaman/shellcheck:{{ .data.shellcheck }} /bin/shellcheck /build

    # Add git-chglog
    RUN env GOBIN=/build go install github.com/git-chglog/git-chglog/cmd/git-chglog@{{ .data.git_chglog }}

    # Add gotestsum
    RUN env GOBIN=/build go install gotest.tools/gotestsum@{{ .data.gotestsum }}

    # Add jq
    COPY --from=ghcr.io/jqlang/jq:{{ .data.jq }} /jq /build

FROM go AS k6
    # The grafana/xk6 image only exists for amd64, so we need to build it for
    # the target architecture.
    RUN env GOBIN=/build go install go.k6.io/xk6/cmd/xk6@{{ .data.xk6 }}

    # The grafana/k6 image only exists for amd64, so we need to build it for
    # the architecture we are targeting. The simplest way to build k6 is to
    # (ab)use xk6 to build a binary without any extensions. In the future, if
    # we wanted additional extensions, this is the place to add them.
    RUN /build/xk6 build {{ .data.k6 }} --output /build/k6

FROM registry.hub.docker.com/library/debian:stable-slim as skopeo
    COPY --from=go /usr/local/go /usr/local/go

    ENV PATH="/usr/local/go/bin:${PATH}"

    RUN apt-get update && \
        apt-get install -y \
        build-essential \
        libgpgme-dev \
        libassuan-dev \
        libdevmapper-dev \
        pkg-config \
        git

    # skopeo is used to inspect container registries. This can be used to
    # inspect the available versions without pulling the repos.
    RUN git clone https://github.com/containers/skopeo && \
        cd skopeo && \
        git checkout "{{ .data.skopeo }}" && \
        make GOBIN=/build DISABLE_DOCS=1 bin/skopeo && \
        mkdir -p /build && \
        cp bin/skopeo /build/

FROM registry.hub.docker.com/library/debian:stable-slim AS final

    RUN apt-get update && \
        apt-get install -y \
            build-essential \
            docker.io \
            file \
            git \
            pkg-config \
            libgpgme11 \
            && \
        rm -rf /var/lib/apt/lists

    COPY --from=go /usr/local/go /usr/local/go
    ENV PATH="/usr/local/go/bin:${PATH}"

    # Keep tools in /usr/local/bin. That makes it a little bit easier to see
    # what comes from the image vs stuff coming from the base image.
    COPY --from=tools /build/* /usr/local/bin/

    COPY --from=k6 /build/* /usr/local/bin/

    COPY --from=skopeo /build/* /usr/local/bin/

    COPY lib/image-test /usr/local/bin

    COPY lib/get-latest-gbt-version /usr/local/bin
