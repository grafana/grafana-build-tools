FROM docker.io/library/golang:{{ .data.go.version }}@{{ .data.go.digest }} AS go
	COPY lib/go.env /usr/local/go/
	RUN mkdir -p /build/bin
	ENV GOMODCACHE=/go/pkg/mod
	ENV GOCACHE=/go/build-cache
	ARG SOURCE_DATE_EPOCH=0
	ENV SOURCE_DATE_EPOCH=${SOURCE_DATE_EPOCH}

{{ range $pkg, $info := .data }}
{{ if (not (index $info "custom_build")) }}
FROM go AS {{ $pkg }}
	ARG TARGET_GOOS
	ARG TARGET_GOARCH

	COPY build/{{ $pkg }} /tmp/build

	RUN --mount=type=cache,target=/go/pkg/mod,id=gomod-${TARGET_GOARCH} \
	    --mount=type=cache,target=/go/build-cache,id=gobuild-${TARGET_GOARCH} \
	    "/tmp/build" "{{ $info.version }}" "${TARGET_GOOS}" "${TARGET_GOARCH}"
{{- end }}
{{- end }}

FROM xk6 AS k6
	ARG TARGET_GOOS
	ARG TARGET_GOARCH

	COPY build/k6 /tmp/build

	RUN "/tmp/build" "{{ .data.k6.version }}" "${TARGET_GOOS}" "${TARGET_GOARCH}"

FROM docker.io/library/debian:stable-slim AS skopeo
	ARG TARGET_GOOS
	ARG TARGET_GOARCH

	COPY --from=go /usr/local/go /usr/local/go
	
	ENV PATH="/usr/local/go/bin:${PATH}"

	RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
	    --mount=type=cache,target=/var/lib/apt,sharing=locked \
	    apt-get update && \
	    apt-get install -y \
	    build-essential \
	    libgpgme-dev \
	    libassuan-dev \
	    libdevmapper-dev \
	    pkg-config \
	    git
	
	# skopeo is used to inspect container registries. This can be used to
	# inspect the available versions without pulling the repos.
	RUN git clone https://github.com/containers/skopeo && \
	    cd skopeo && \
	    git checkout "{{ .data.skopeo.version }}" && \
	    make GOPATH=/build DISABLE_DOCS=1 bin/skopeo.${TARGET_GOOS}.${TARGET_GOARCH} && \
	    mkdir -p /build/bin && \
	    cp bin/skopeo.${TARGET_GOOS}.${TARGET_GOARCH} /build/bin/skopeo

FROM scratch AS shellcheck
	COPY --from=docker.io/koalaman/shellcheck:{{ .data.shellcheck.version }}@{{ .data.shellcheck.digest }} /bin/shellcheck /build/bin/

FROM scratch AS jq
	COPY --from=ghcr.io/jqlang/jq:{{ .data.jq.version }}@{{ .data.jq.digest }} /jq /build/bin/

FROM docker.io/library/debian:stable-slim AS final
    RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
        --mount=type=cache,target=/var/lib/apt,sharing=locked \
        apt-get update && \
        apt-get install -y \
            build-essential \
            docker.io \
            file \
            git \
            pkg-config \
            libgpgme11 \
            curl \
            ca-certificates \
            7zip-standalone

    COPY lib/image-test /usr/local/bin

    COPY lib/golangci-lint /usr/local/bin

    COPY lib/get-latest-gbt-version /usr/local/bin

    COPY --from=go /usr/local/go /usr/local/go

    {{ range $pkg, $info := .data }}
    {{ if (not (index $info "custom_install")) }}
    COPY --from={{ $pkg }} /build/bin/* /usr/local/bin/
    {{ end }}
    {{ end }}

    ENV PATH="/usr/local/go/bin:${PATH}"
